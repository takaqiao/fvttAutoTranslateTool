# Foundry VTT 模组智能汉化脚本 (V26)

本文档说明了基于 Babele 格式 JSON 文件的 Foundry VTT 模组自动化翻译脚本的功能特性与技术细节。
**V26 版本** 引入了“智能哈希缓存”与“全量快照备份”系统，专为长期维护的大型模组翻译项目设计。

## 1. 极速核心引擎 (Hyper-Speed Engine)
* **定速巡航模式 (Rate Pacing)**：内置 `RateLimiter` 控制器，将请求频率精准锁定在 **950 RPM** (Requests Per Minute)。完美适配 Google Gemini Flash 模型的速率限制，既榨干 API 额度，又杜绝 `429 Too Many Requests` 错误。
* **高并发架构**：默认开启 **64 线程**。利用 Python 的多线程特性处理网络 I/O 等待，实现“发射即回收”的流水线作业，大幅缩短总耗时。
* **算法级优化**：重写术语匹配逻辑，采用 **Set 预筛选 + 正则匹配** 策略。在处理 50,000+ 条术语表时，将 CPU 匹配耗时降低 50 倍以上，消除本地性能瓶颈。

## 2. 智能增量与缓存 (Smart Audit & Caching)
脚本引入了持久化缓存机制，不再对所有条目进行重复审核，大幅降低 Token 消耗：
* **智能哈希锁 (Hash Locking)**：
    * 脚本计算 `(英文原文 + 中文译文)` 的唯一哈希值。
    * **已验证项**：若某条翻译在之前运行中被 AI 标记为“保留 (Kept)”，其哈希值会被永久记录。下一次运行时自动跳过，**零 API 消耗**。
    * **待验证项**：新生成 (New) 或被修正 (Fixed) 的条目不会进入缓存，会在下一次运行时再次送审，直至收敛。
* **增量构建**：随着运行次数增加，待处理任务数呈指数级下降，最终实现秒级构建。

## 3. 术语一致性管理 (Context Alignment)
* **本地术语优先 (Local Priority)**：
    * 运行前自动扫描**半成品汉化文件**，智能提取人名、地名、物品名等短词，生成 `术语表_本地提取.csv`。
    * **优先级逻辑**：`本地术语` > `全局大表` > `AI 自由发挥`。确保同一模组内的专有名词（如 NPC 名字）与之前的翻译保持绝对一致。
* **严格大小写匹配 (Smart Regex)**：
    * **智能区分**：若术语表中的词包含大写（如 `Will`），执行严格大小写匹配（不匹配 `will`）；若为全小写（如 `dagger`），则允许忽略大小写匹配（兼容 `Dagger`）。
    * **冲突审计**：自动合并完全重复项，并记录因译名冲突而被覆盖的条目到 `术语丢弃日志.txt`。

## 4. 智能格式控制 (Smart Formatting)
* **防重双语补全**：
    * **指纹检测**：计算英文原文的内容指纹。
    * **智能判断**：
        * 若译文中已包含英文（如：`借机攻击 (Attack of Opportunity)`），脚本**保持原样**，不重复添加。
        * 若译文为纯中文，脚本自动补全标准格式：`<中文><br><br><hr><b>原文:</b><br><英文>`。
* **强力代码保护**：
    * 强制开启保护逻辑，自动隐藏 HTML 标签（如 `<div class="...">`）、Foundry 系统代码（`@UUID`, `[[/r ...]]`）及转义符。
* **注入清洗**：在后处理阶段强力清除 AI 可能残留的辅助标签（如 `⟪...|原文:...⟫`），确保最终文本纯净。

## 5. 数据结构处理
* **JSON 深度递归**：支持遍历 Foundry VTT 及 Babele 模组复杂的嵌套 JSON 结构。
* **字段定向翻译**：
    * **白名单机制**：仅翻译 `name`, `description`, `text`, `label`, `caption`, `value`, `unidentifiedName`, `publicNotes` 等关键字段。
    * **特殊容器穿透**：强制递归翻译 `notes` (地图笔记) 和 `folders` (文件夹名称) 路径下的所有字符串。

## 6. 日志与质量控制
脚本运行将生成多份独立文件，全方位监控翻译质量：

1.  **AI 校对报告 (`翻译审查报告.xlsx`)**：
    * 分 Sheet 记录 `新译`、`修正`、`保留` 的条目，便于人工复核。
2.  **运行日志 (`运行日志.txt`)**：
    * 记录 API 错误重试、网络波动等系统级信息。
3.  **历史哈希库 (`translation_history.json`)**：
    * 记录所有已通过审核的文本指纹（请勿手动修改）。

## 7. 健壮性与备份系统 (Snapshot Backup)
* **全量快照备份**：
    * 每次运行前，自动将以下文件打包备份至 `backups/` 目录，并打上精确到秒的时间戳：
        * 目标汉化文件 (`.json`)
        * 上一次的审查报告 (`.xlsx`)
        * 本地提取的术语表 (`.csv`)
        * 哈希缓存文件 (`.json`)
    * 方便随时回溯查看任意版本的翻译状态和 AI 决策历史。
* **文件锁保护**：
    * 若 CSV/Excel 被占用，脚本会挂起提示而非崩溃。
* **自动重试机制**：
    * 遇到 API 404/500/503 错误时，自动进行 5 级指数退避重试。

## 8. 致谢与数据来源
本项目的核心术语表数据来源于 **[开拓者2版中文维基 (灰机Wiki)](https://pf2.huijiwiki.com/wiki/%E6%9C%AF%E8%AF%AD%E7%B4%A2%E5%BC%95)**。